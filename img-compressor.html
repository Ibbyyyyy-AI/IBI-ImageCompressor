<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>IBI TOOLS — Image Compressor</title>
  <meta name="description" content="IBI TOOLS Image Compressor — compress images in your browser. Choose final size (KB) or quality (%) with automatic scaling. No uploads.">

  <style>
    /* Theme-aware styles inspired by the very first version but simplified for clarity */
    :root{
      --bg:#071025; --card:#0b1220; --muted:#94a3b8; --accent:#7c3aed; --glass: rgba(255,255,255,0.03); --text:#e6eef8
    }
    @media (prefers-color-scheme:light){
      :root{ --bg:#f8fafc; --card:#ffffff; --muted:#475569; --accent:#0ea5a4; --glass: rgba(2,6,23,0.03); --text:#0f172a }
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:linear-gradient(180deg,var(--bg) 0%, #031124 100%);color:var(--text);padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto 12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:48px;height:48px;border-radius:8px;background:linear-gradient(135deg,#5eead4,#60a5fa);display:flex;align-items:center;justify-content:center;color:#022;font-weight:700}
    .container{max-width:1100px;margin:0 auto}
    main{display:grid;grid-template-columns:1fr 360px;gap:16px}
    @media (max-width:940px){main{grid-template-columns:1fr;padding:0}}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.4)}
    .controls{display:grid;gap:12px}
    .row{display:flex;gap:8px;align-items:center}
    label{color:var(--muted);font-size:14px}
    .muted{color:var(--muted)}
    input, select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:inherit}
    input[type=range]{width:180px}
    button{background:linear-gradient(90deg,var(--accent),#06b6d4);border:0;padding:8px 12px;border-radius:8px;color:#021;cursor:pointer;font-weight:600}
    .preview-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:12px}
    .preview{background:var(--glass);padding:8px;border-radius:8px;display:flex;flex-direction:column;gap:6px;align-items:center}
    .thumb{width:100%;height:140px;object-fit:contain;background:#061428;border-radius:6px}
    footer{margin-top:16px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <header class="container">
    <div class="brand">
      <div class="logo">IBI</div>
      <div>
        <div style="font-weight:700">IBI TOOLS</div>
        <div class="muted" style="font-size:13px">Image Compressor — fast, private, browser-only</div>
      </div>
    </div>
    <div class="muted">Made by IBI</div>
  </header>

  <div class="container">
    <main>
      <section class="card" aria-labelledby="tool-title">
        <h2 id="tool-title">Compress images (choose size or quality)</h2>
        <p class="muted">Select one or more images. You can set a final file size (KB) or a quality percentage. Use "Auto-scale" to make quality also reduce image dimensions for smaller files.</p>

        <div class="controls">
          <div class="row">
            <input id="fileInput" type="file" accept="image/*" multiple aria-label="Select images">
            <button id="clearBtn">Clear</button>
          </div>

          <div class="row" style="align-items:center">
            <label for="mode">Mode:</label>
            <select id="mode">
              <option value="target">Target file size (KB)</option>
              <option value="quality">Quality percentage</option>
            </select>

            <input id="targetKB" type="number" min="1" placeholder="200" style="width:110px">

            <input id="quality" type="range" min="5" max="100" value="80" aria-label="Quality slider">
            <div id="qualityVal" class="muted">80%</div>
          </div>

          <div class="row">
            <label>Format:</label>
            <select id="format">
              <option value="webp">WebP (recommended)</option>
              <option value="jpeg">JPEG</option>
              <option value="png">PNG</option>
            </select>

            <label style="margin-left:8px">Auto-scale:</label>
            <select id="scaleMode">
              <option value="auto">Scale with quality (recommended)</option>
              <option value="none">Do not scale (quality only)</option>
            </select>

            <label style="margin-left:8px">Max width (px):</label>
            <input id="maxWidth" type="number" min="16" placeholder="optional" style="width:110px">
            <label>Max height (px):</label>
            <input id="maxHeight" type="number" min="16" placeholder="optional" style="width:110px">
          </div>

          <div class="row">
            <button id="compressAll">Compress All</button>
            <button id="zipBtn">Download ZIP</button>
            <div class="muted" id="progress">0 / 0</div>
          </div>

          <div id="results" class="preview-grid" aria-live="polite"></div>
        </div>
      </section>

      <aside>
        <div class="card">
          <h3>Info</h3>
          <p class="muted">This tool runs in your browser — images never leave your device. Use WebP for best compression. If target size can't be reached by quality alone the tool will reduce dimensions automatically.</p>
        </div>
      </aside>
    </main>

    <footer>Made by IBI — IBI TOOLS</footer>
  </div>

  <!-- JSZip for ZIP download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
  // Utilities
  function readFileAsDataURL(file){
    return new Promise(function(res, rej){
      var r = new FileReader(); r.onload = function(){ res(r.result); }; r.onerror = rej; r.readAsDataURL(file);
    });
  }

  function imageFromDataURL(dataURL){
    return new Promise(function(res, rej){
      var img = new Image(); img.onload = function(){ res(img); }; img.onerror = rej; img.src = dataURL;
    });
  }

  function canvasToBlob(canvas, mimeType, quality){
    return new Promise(function(res){ canvas.toBlob(res, mimeType, quality); });
  }

  function humanBytes(bytes){
    if(bytes < 1024) return bytes + ' B';
    if(bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
    return (bytes/1024/1024).toFixed(2) + ' MB';
  }

  // Auto-scale mapping: qualityFraction (0.05-1) -> scale between 0.25 and 1
  function qualityToScale(qf){
    var minScale = 0.25; return minScale + (qf * (1 - minScale));
  }

  // Core compression: supports 'quality' mode and 'target' mode
  async function compressImage(file, opts){
    // opts: {mode, targetKB, qualityPct, format, maxWidth, maxHeight, scaleMode}
    var dataURL = await readFileAsDataURL(file);
    var img = await imageFromDataURL(dataURL);
    var w = img.naturalWidth, h = img.naturalHeight;
    if(opts.maxWidth && w > opts.maxWidth){ var r = opts.maxWidth / w; w = Math.round(w * r); h = Math.round(h * r); }
    if(opts.maxHeight && h > opts.maxHeight){ var r2 = opts.maxHeight / h; w = Math.round(w * r2); h = Math.round(h * r2); }

    var mime = opts.format === 'png' ? 'image/png' : (opts.format === 'jpeg' ? 'image/jpeg' : 'image/webp');

    async function blobFor(dimW, dimH, quality){
      var canvas = document.createElement('canvas'); canvas.width = dimW; canvas.height = dimH;
      var ctx = canvas.getContext('2d'); ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight, 0, 0, dimW, dimH);
      var blob = await canvasToBlob(canvas, mime, quality);
      return { blob: blob, width: dimW, height: dimH };
    }

    if(opts.mode === 'quality'){
      var q = Math.max(0.05, Math.min(1, opts.qualityPct / 100));
      var outW = w, outH = h;
      if(opts.scaleMode === 'auto'){
        var scale = qualityToScale(q); outW = Math.max(1, Math.round(outW * scale)); outH = Math.max(1, Math.round(outH * scale));
      }
      var result = await blobFor(outW, outH, q);
      return result;
    }

    if(opts.mode === 'target'){
      var targetBytes = Math.max(1, opts.targetKB || 1) * 1024;
      var lo = 0.04, hi = 0.98, best = null;
      for(var iter = 0; iter < 9; iter++){
        var qx = (lo + hi) / 2;
        var attempt = await blobFor(w, h, qx);
        var size = attempt.blob.size;
        if(size <= targetBytes){ best = { blob: attempt.blob, width: attempt.width, height: attempt.height, quality: qx }; lo = qx; }
        else { hi = qx; }
        if(best && Math.abs(best.blob.size - targetBytes) / targetBytes < 0.08) break;
      }
      if(best) return best;

      // If quality alone can't reach target, downscale then try again
      var currentW = w, currentH = h;
      for(var step = 0; step < 8; step++){
        currentW = Math.max(32, Math.round(currentW * 0.85)); currentH = Math.max(32, Math.round(currentH * 0.85));
        var lo2 = 0.04, hi2 = 0.98, localBest = null;
        for(var it2 = 0; it2 < 7; it2++){
          var q2 = (lo2 + hi2) / 2; var attempt2 = await blobFor(currentW, currentH, q2);
          if(attempt2.blob.size <= targetBytes){ localBest = { blob: attempt2.blob, width: attempt2.width, height: attempt2.height, quality: q2 }; lo2 = q2; }
          else { hi2 = q2; }
          if(localBest && Math.abs(localBest.blob.size - targetBytes) / targetBytes < 0.08) break;
        }
        if(localBest) return localBest;
      }

      // fallback: return last attempt at low quality
      var fallback = await blobFor(Math.max(64, currentW), Math.max(64, currentH), 0.04);
      return fallback;
    }
  }

  // UI wiring
  var fileInput = document.getElementById('fileInput');
  var clearBtn = document.getElementById('clearBtn');
  var modeSel = document.getElementById('mode');
  var targetKBInput = document.getElementById('targetKB');
  var qualityRange = document.getElementById('quality');
  var qualityVal = document.getElementById('qualityVal');
  var formatSel = document.getElementById('format');
  var scaleModeSel = document.getElementById('scaleMode');
  var maxWidthInput = document.getElementById('maxWidth');
  var maxHeightInput = document.getElementById('maxHeight');
  var compressAllBtn = document.getElementById('compressAll');
  var zipBtn = document.getElementById('zipBtn');
  var results = document.getElementById('results');
  var progress = document.getElementById('progress');

  var currentFiles = [];

  fileInput.addEventListener('change', function(e){ currentFiles = Array.prototype.slice.call(e.target.files || []).filter(function(f){ return f.type && f.type.indexOf('image') === 0; }); renderList(); });
  clearBtn.addEventListener('click', function(){ fileInput.value = ''; currentFiles = []; renderList(); });
  qualityRange.addEventListener('input', function(){ qualityVal.textContent = qualityRange.value + '%'; });

  function renderList(){ results.innerHTML = ''; for(var i=0;i<currentFiles.length;i++){
    var f = currentFiles[i]; var el = document.createElement('div'); el.className = 'preview'; el.dataset.index = i;
    var img = document.createElement('img'); img.className = 'thumb'; img.alt = f.name; img.loading = 'lazy';
    var name = document.createElement('div'); name.textContent = f.name; name.className = 'muted';
    var stat = document.createElement('div'); stat.textContent = 'Original: ' + humanBytes(f.size);
    var actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
    var btn = document.createElement('button'); btn.textContent = 'Compress';
    var dl = document.createElement('a'); dl.textContent = 'Download'; dl.style.display='none'; dl.className='muted';
    actions.appendChild(btn); actions.appendChild(dl);
    el.appendChild(img); el.appendChild(name); el.appendChild(stat); el.appendChild(actions);
    results.appendChild(el);
    // preview
    (function(file,imgEl){ readFileAsDataURL(file).then(function(url){ imgEl.src = url; }); })(f,img);

    // single compress
    (function(file,button,dlEl,statEl){ button.addEventListener('click', async function(){ button.disabled = true; button.textContent = 'Working...'; try{
      var opts = getOptions(); var res = await compressImage(file, opts); var outBlob = res.blob; var outUrl = URL.createObjectURL(outBlob); dlEl.href = outUrl; dlEl.download = file.name.replace(/\.[^.]+$/, '') + (opts.format==='png'?'.png':(opts.format==='jpeg'?'.jpg':'.webp')); dlEl.style.display='inline-block'; statEl.textContent = 'Output: ' + humanBytes(outBlob.size);
    }catch(err){ statEl.textContent = 'Error'; console.error(err); }
    button.textContent = 'Compress'; button.disabled = false; }); })(f,btn,dl,stat);
  }
  progress.textContent = '0 / ' + currentFiles.length;
  }

  function getOptions(){ return { mode: modeSel.value, targetKB: Number(targetKBInput.value) || 200, qualityPct: Number(qualityRange.value) || 80, format: formatSel.value, scaleMode: scaleModeSel.value, maxWidth: Number(maxWidthInput.value) || null, maxHeight: Number(maxHeightInput.value) || null }; }

  compressAllBtn.addEventListener('click', async function(){ if(currentFiles.length === 0) return alert('Pick some images first.'); compressAllBtn.disabled = true; compressAllBtn.textContent = 'Compressing...'; var opts = getOptions(); var done = 0; for(var i=0;i<currentFiles.length;i++){ var el = results.querySelector('.preview[data-index="'+i+'"]'); var stat = el.querySelector('div:nth-child(3)'); var btn = el.querySelector('button'); var dl = el.querySelector('a'); btn.disabled = true; btn.textContent = 'Working...'; try{ var res = await compressImage(currentFiles[i], opts); var blob = res.blob; var url = URL.createObjectURL(blob); dl.href = url; dl.download = currentFiles[i].name.replace(/\.[^.]+$/, '') + (opts.format==='png'?'.png':(opts.format==='jpeg'?'.jpg':'.webp')); dl.style.display = 'inline-block'; stat.textContent = 'Output: ' + humanBytes(blob.size); }catch(err){ stat.textContent = 'Error'; console.error(err); } done++; progress.textContent = done + ' / ' + currentFiles.length; btn.disabled = false; btn.textContent = 'Compress'; } compressAllBtn.disabled = false; compressAllBtn.textContent = 'Compress All'; });

  zipBtn.addEventListener('click', async function(){ if(currentFiles.length === 0) return alert('No files'); zipBtn.disabled = true; zipBtn.textContent = 'Preparing...'; var zip = new JSZip(); var opts = getOptions(); for(var i=0;i<currentFiles.length;i++){ try{ var res = await compressImage(currentFiles[i], opts); zip.file(currentFiles[i].name.replace(/\.[^.]+$/, '') + (opts.format==='png'?'.png':(opts.format==='jpeg'?'.jpg':'.webp')), res.blob); }catch(e){ console.error('zip error', e); } } var out = await zip.generateAsync({type:'blob'}); var a = document.createElement('a'); a.href = URL.createObjectURL(out); a.download = 'compressed.zip'; a.click(); zipBtn.disabled = false; zipBtn.textContent = 'Download ZIP'; });

  </script>
</body>
</html>
